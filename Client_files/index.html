<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" type="text/css" href="index.css">
  <title>Landing page</title>

</head>
<body>
  <!--Header text-->
  <div id="header" class="header">
    <p id="title" class="title">Hey!</p>
    <p id="subtitle" class="subTitle">Do you want to login or sign up?</p>
  </div>


<!--Landing page-->
<div class="emailInputform">
  <p class="emailInputFlavorText">Please enter your email below</p>
  <input type="email" maxlength="576" required id="emailInputField" name="email" placeholder="some@email.com">

  <!--Sign up button-->
  <input type="submit" id="signupButton" class="signupButton" value="Sign up" onClick="sign_in_or_up('signUpPassword')"></button>

  <!--Login button-->
  <input type="submit" id="loginButton" class="loginButton" value="Login" onClick="sign_in_or_up('loginPassword')"></button>
</div>

<script src="aes.js"></script> <!-- for AES256 encryption -->
<script>
  let encryptionPassword = "";

  //first gets the encryption password, then posts the email
  function sign_in_or_up(inOrUp) {
    console.log(window.location.href);
    let output = "";
    let xhr2 = new XMLHttpRequest();
    //get the email
    let email = document.getElementById("emailInputField").value;
    //validate email format
    if(validateEmail(email) == false) {
      alert("invalid email");
      return;
    }

    //the outer xhr (xhr2) is for getting the ecryption password,
    //while the inner xhr is for posting the email to the server
    xhr2.open("GET", window.location.href + "getPassword", true);
    xhr2.onreadystatechange = function() {
      if (xhr2.readyState === 4) {
        output = xhr2.responseText;
        //return via global variable
        encryptionPassword = output;
        //make a new XML http request
        let xhr = new XMLHttpRequest();
        xhr.open("POST", window.location.href, true);
        xhr.setRequestHeader('Content-Type', 'application/json'); //find out if it needs to be json
        //wait for response
        xhr.onreadystatechange = function() {
          if (xhr.readyState === 4)  { 
            //server has now given response
            let serverResponse = xhr.responseText;
            //console.log(serverResponse);
            if(serverResponse == "success") {
              //save a cookie containing the email, for use during sign in or sign up
              set_cookie("email", email, 5) //5 minute expiration
              //redirect to password input
              window.location.replace(window.location.href + inOrUp);
            }else {
              //email error messages
              if(inOrUp == "loginPassword") {
                alert("Account does not exist");
              } else {
                alert("Account already exists");
              }
            }
          }
        };
        //console.log(encryptionPassword);
        let encryptedEmail = encrypt_string(email, encryptionPassword);
        if(inOrUp == 'loginPassword') {
          xhr.send("sign in " + encryptedEmail);
        }else if(inOrUp == 'signUpPassword') {
          xhr.send("sign up " + encryptedEmail);
        }
      }
    }
    xhr2.send();
  }

  //edited from https://www.w3schools.com/js/js_cookies.asp
  function set_cookie(cname, cvalue, exminutes) {
    var d = new Date();
    d.setTime(d.getTime() + (exminutes*60*1000));
    var expires = "expires="+ d.toUTCString();
    document.cookie = cname + "=" + cvalue + ";" + expires + ";path=/";
  }


  //https://www.npmjs.com/package/crypto-js
  //https://cryptojs.gitbook.io/docs/
  //https://code.google.com/archive/p/crypto-js/

  //teststring
  //var testString = "rfajewriofjwaoigfejb ioergniggdyeiuafreygiueraybiuerayrteaiubyer";

  function encrypt_string(input, password){ 

    //input != string error handling
    if (typeof input != "string"){
      console.log("encrypt_string - error: input is not a string");
      return;
    }

    //encrypting function
    const ciphertext = Aes.Ctr.encrypt(input, password, 256);

    //returns encrypted string
    return ciphertext;
  }

  

  //email format validation, from https://stackoverflow.com/questions/46155/how-to-validate-an-email-address-in-javascript
  function validateEmail(email) {
    var re = /^(([^<>()\[\]\\.,;:\s@"]+(\.[^<>()\[\]\\.,;:\s@"]+)*)|(".+"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/;
    return re.test(String(email).toLowerCase());
  }
</script>


</body>
</html>